<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ Gin</title>
    <link rel="stylesheet" href="./asserts/styles.css">
</head>

<body>
    <div class="container">
        <div class="card">
            <h1>üìÅ –§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ Gin</h1>
            
            <div class="status" id="serverStatus">
                –ó–∞–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Ä–≤–µ—Ä–µ...
            </div>
            
            <!-- –§–æ—Ä–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ -->
            <div id="uploadSection">
                <h2>–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤</h2>
                
                <div class="alert" id="uploadAlert"></div>
                
                <div class="upload-area" id="dropArea">
                    <p>üì§ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏</p>
                    <input type="file" id="fileInput" multiple style="display: none;">
                    <button class="btn" onclick="document.getElementById('fileInput').click()">
                        –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã
                    </button>
                    <p style="margin-top: 10px; color: #718096; font-size: 14px;">
                        –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10MB
                    </p>
                </div>
                
                <div class="progress" id="progressBar">
                    <div class="progress-bar" id="progressFill"></div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="uploadFile()" id="uploadBtn">
                        –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª(—ã)
                    </button>
                    <button class="btn btn-secondary" onclick="refreshFileList()">
                        –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                    </button>
                </div>
            </div>
            
            <!-- –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ -->
            <div class="file-list" id="fileListSection">
                <h2>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h2>
                <div id="fileList">
                    –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        
        // Drag & Drop
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        
        dropArea.addEventListener('click', () => fileInput.click());
        
        fileInput.addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            showSelectedFiles();
        });
        
        // Drag events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.add('dragover');
            }, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, () => {
                dropArea.classList.remove('dragover');
            }, false);
        });
        
        dropArea.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            selectedFiles = Array.from(dt.files);
            showSelectedFiles();
        });
        
        function showSelectedFiles() {
            if (selectedFiles.length === 0) return;
            
            let message = `–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${selectedFiles.length}<br>`;
            selectedFiles.forEach(file => {
                message += `‚Ä¢ ${file.name} (${formatBytes(file.size)})<br>`;
            });
            
            showAlert(message, 'success');
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤
        async function uploadFile() {
            if (selectedFiles.length === 0) {
                showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            uploadBtn.disabled = true;
            progressBar.style.display = 'block';
            
            const formData = new FormData();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤
            let totalSize = 0;
            for (const file of selectedFiles) {
                if (file.size > 10 * 1024 * 1024) {
                    showAlert(`–§–∞–π–ª ${file.name} –ø—Ä–µ–≤—ã—à–∞–µ—Ç 10MB`, 'error');
                    uploadBtn.disabled = false;
                    progressBar.style.display = 'none';
                    return;
                }
                totalSize += file.size;
            }
            
            if (totalSize > 50 * 1024 * 1024) {
                showAlert('–û–±—â–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤ –ø—Ä–µ–≤—ã—à–∞–µ—Ç 50MB', 'error');
                uploadBtn.disabled = false;
                progressBar.style.display = 'none';
                return;
            }
            
            selectedFiles.forEach(file => {
                formData.append('files', file);
            });
            
            try {
                const response = await fetch('/upload/multiple', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${result.files?.length || 0} —Ñ–∞–π–ª–æ–≤`, 'success');
                    selectedFiles = [];
                    fileInput.value = '';
                    refreshFileList();
                    refreshStatus();
                } else {
                    showAlert(result.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            } finally {
                uploadBtn.disabled = false;
                progressBar.style.display = 'none';
                progressFill.style.width = '0%';
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        async function refreshFileList() {
            try {
                const response = await fetch('/files');
                const result = await response.json();
                
                if (response.ok) {
                    renderFileList(result.files);
                }
            } catch (error) {
                document.getElementById('fileList').innerHTML = 
                    '<div class="alert alert-error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤</div>';
            }
        }
        
        function renderFileList(files) {
            if (!files || files.length === 0) {
                document.getElementById('fileList').innerHTML = 
                    '<div class="file-item">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>';
                return;
            }
            
            let html = '';
            files.forEach(file => {
                if (!file.isDir) {
                    html += `
                        <div class="file-item">
                            <div class="file-info">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">
                                    ${formatBytes(file.size)} ‚Ä¢ 
                                    ${new Date(file.modTime).toLocaleString()}
                                </div>
                            </div>
                            <div class="file-actions">
                                <button class="btn" onclick="downloadFile('${file.name}')">
                                    üì• –°–∫–∞—á–∞—Ç—å
                                </button>
                                <button class="btn btn-secondary" onclick="viewFile('${file.name}')">
                                    üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä
                                </button>
                                <button class="btn btn-danger" onclick="deleteFile('${file.name}')">
                                    üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                                </button>
                            </div>
                        </div>
                    `;
                }
            });
            
            document.getElementById('fileList').innerHTML = html;
        }
        
        // –î–µ–π—Å—Ç–≤–∏—è —Å —Ñ–∞–π–ª–∞–º–∏
        function downloadFile(filename) {
            window.open(`/download/${encodeURIComponent(filename)}`, '_blank');
        }
        
        function viewFile(filename) {
            window.open(`/files/${encodeURIComponent(filename)}`, '_blank');
        }
        
        async function deleteFile(filename) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª "${filename}"?`)) return;
            
            try {
                const response = await fetch(`/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert(`–§–∞–π–ª "${filename}" —É–¥–∞–ª–µ–Ω`, 'success');
                    refreshFileList();
                    refreshStatus();
                } else {
                    const result = await response.json();
                    showAlert(result.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                showAlert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
            }
        }
        
        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞
        async function refreshStatus() {
            try {
                const response = await fetch('/status');
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('serverStatus').innerHTML = `
                        <strong>–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞:</strong><br>
                        ‚Ä¢ –§–∞–π–ª–æ–≤: ${result.filesCount}<br>
                        ‚Ä¢ –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${formatBytes(result.totalSize)}<br>
                        ‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${result.uploadDir}<br>
                        ‚Ä¢ –í—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä–∞: ${new Date(result.serverTime).toLocaleString()}
                    `;
                }
            } catch (error) {
                document.getElementById('serverStatus').innerHTML = 
                    '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–µ—Ä–∞';
            }
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function showAlert(message, type = 'info') {
            const alertDiv = document.getElementById('uploadAlert');
            alertDiv.innerHTML = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            refreshFileList();
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(() => {
                refreshFileList();
                refreshStatus();
            }, 30000);
        });
    </script>
</body>
</html>